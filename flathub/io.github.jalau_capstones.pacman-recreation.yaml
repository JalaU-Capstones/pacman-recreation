app-id: io.github.jalau_capstones.pacman-recreation
runtime: org.freedesktop.Platform
runtime-version: '25.08'
sdk: org.freedesktop.Sdk
sdk-extensions:
  - org.freedesktop.Sdk.Extension.dotnet9
build-options:
  append-path: /usr/lib/sdk/dotnet9/bin
  env:
    DOTNET_ROOT: /usr/lib/sdk/dotnet9
    DOTNET_CLI_TELEMETRY_OPTOUT: '1'
    LD_LIBRARY_PATH: /app/lib/pacman-recreation:/usr/lib/x86_64-linux-gnu/ffmpeg/lib
command: pacman-recreation
finish-args:
  - --socket=x11
  - --share=ipc
  - --device=dri
  - --socket=pulseaudio
  - --share=network
  - --env=LD_LIBRARY_PATH=/app/lib/pacman-recreation:/usr/lib/x86_64-linux-gnu/ffmpeg/lib
modules:
  - name: pacman-recreation
    buildsystem: simple
    build-commands:
      - |
        dotnet publish src/PacmanGame/PacmanGame.csproj \
          -c Release \
          -r linux-x64 \
          --self-contained true \
          --source ./nuget-sources \
          -o /app/lib/pacman-recreation \
          /p:PublishSingleFile=false \
          /p:DebugType=None \
          /p:DebugSymbols=false \
          /p:RuntimeFrameworkVersion=9.0.13 \
          /p:AspNetCoreRuntimeFrameworkVersion=9.0.13

      # SFML Native Library Fixes
      - find /usr/lib/x86_64-linux-gnu -name "libFLAC.so.*" -exec ln -s {} /app/lib/pacman-recreation/libFLAC.so.8 \;
      - cd /app/lib/pacman-recreation && ln -s libcsfml-audio.so csfml-audio
      - cd /app/lib/pacman-recreation && ln -s libcsfml-system.so csfml-system

      - mkdir -p /app/share/pacman-recreation
      - cp -r /app/lib/pacman-recreation/Assets /app/share/pacman-recreation/
      - install -Dm755 pacman-recreation.sh /app/bin/pacman-recreation
      - install -Dm644 io.github.jalau_capstones.pacman-recreation.desktop /app/share/applications/io.github.jalau_capstones.pacman-recreation.desktop
      - install -Dm644 io.github.jalau_capstones.pacman-recreation.metainfo.xml /app/share/metainfo/io.github.jalau_capstones.pacman-recreation.metainfo.xml

      # Icons
      - install -Dm644 64x64.png /app/share/icons/hicolor/64x64/apps/io.github.jalau_capstones.pacman-recreation.png
      - install -Dm644 128x128.png /app/share/icons/hicolor/128x128/apps/io.github.jalau_capstones.pacman-recreation.png
      - install -Dm644 256x256.png /app/share/icons/hicolor/256x256/apps/io.github.jalau_capstones.pacman-recreation.png
      - install -Dm644 512x512.png /app/share/icons/hicolor/512x512/apps/io.github.jalau_capstones.pacman-recreation.png
    sources:
      - type: git
        url: https://github.com/JalaU-Capstones/pacman-recreation.git
        tag: v1.0.0
        commit: 525cdb36181621cee636060197be5596920daba4
      - generated-sources.json
      - type: file
        path: io.github.jalau_capstones.pacman-recreation.desktop
      - type: file
        path: io.github.jalau_capstones.pacman-recreation.metainfo.xml
      - type: script
        dest-filename: pacman-recreation.sh
        commands:
          - export ASSETS_PATH=/app/share/pacman-recreation/Assets
          - export LD_LIBRARY_PATH=/app/lib/pacman-recreation:$LD_LIBRARY_PATH
          # Hint Avalonia to try Wayland first to avoid X11 errors where possible
          - exec /app/lib/pacman-recreation/PacmanGame --platform-hint=wayland,x11
      - type: file
        path: 64x64.png
      - type: file
        path: 128x128.png
      - type: file
        path: 256x256.png
      - type: file
        path: 512x512.png
