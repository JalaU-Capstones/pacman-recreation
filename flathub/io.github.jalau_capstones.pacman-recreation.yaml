app-id: io.github.jalau_capstones.pacman-recreation
runtime: org.freedesktop.Platform
runtime-version: '25.08'
sdk: org.freedesktop.Sdk
sdk-extensions:
  - org.freedesktop.Sdk.Extension.dotnet9
build-options:
  append-path: /usr/lib/sdk/dotnet9/bin
  env:
    DOTNET_ROOT: /usr/lib/sdk/dotnet9
    DOTNET_CLI_TELEMETRY_OPTOUT: '1'
command: pacman-recreation
finish-args:
  - --socket=x11
  - --share=ipc
  - --device=dri
  - --socket=pulseaudio
  - --share=network
modules:
  - name: pacman-recreation
    buildsystem: simple
    build-commands:
      # 1. Dynamic architecture selection for .NET
      - |
        if [ "$FLATPAK_ARCH" = "aarch64" ]; then
          RID="linux-arm64"
        else
          RID="linux-x64"
        fi

        dotnet publish src/PacmanGame/PacmanGame.csproj \
          -c Release \
          -r $RID \
          --no-self-contained \
          --source ./nuget-sources \
          -o /app/lib/pacman-recreation \
          /p:PublishSingleFile=false \
          /p:DebugType=None \
          /p:DebugSymbols=false \
          /p:RuntimeFrameworkVersion=9.0.13 \
          /p:AspNetCoreRuntimeFrameworkVersion=9.0.13 \
          /p:TargetLatestRuntimePatch=true

      # 2. Native library fixes adapted to ANY architecture
      - find /usr/lib/$(gcc -print-multiarch) -name "libFLAC.so.*" -exec ln -sf {} /app/lib/pacman-recreation/libFLAC.so.8 \;
      - cd /app/lib/pacman-recreation && ln -sf libcsfml-audio.so csfml-audio
      - cd /app/lib/pacman-recreation && ln -sf libcsfml-system.so csfml-system

      - mkdir -p /app/share/pacman-recreation
      - cp -r /app/lib/pacman-recreation/Assets /app/share/pacman-recreation/
      - install -Dm755 pacman-recreation.sh /app/bin/pacman-recreation
      
      # 3. "Upstream" installation (Pulls directly from the flathub/ folder of your repo)
      - install -Dm644 flathub/io.github.jalau_capstones.pacman-recreation.desktop /app/share/applications/io.github.jalau_capstones.pacman-recreation.desktop
      - install -Dm644 flathub/io.github.jalau_capstones.pacman-recreation.metainfo.xml /app/share/metainfo/io.github.jalau_capstones.pacman-recreation.metainfo.xml
      - install -Dm644 flathub/64x64.png /app/share/icons/hicolor/64x64/apps/io.github.jalau_capstones.pacman-recreation.png
      - install -Dm644 flathub/128x128.png /app/share/icons/hicolor/128x128/apps/io.github.jalau_capstones.pacman-recreation.png
      - install -Dm644 flathub/256x256.png /app/share/icons/hicolor/256x256/apps/io.github.jalau_capstones.pacman-recreation.png
      - install -Dm644 flathub/512x512.png /app/share/icons/hicolor/512x512/apps/io.github.jalau_capstones.pacman-recreation.png
    sources:
      - type: git
        url: https://github.com/JalaU-Capstones/pacman-recreation.git
        tag: v1.0.0
        commit: b4a1325b03fe436fdf8cef1401cde9b2d38006fd
      - generated-sources.json
      - type: script
        dest-filename: pacman-recreation.sh
        commands:
          - export ASSETS_PATH=/app/share/pacman-recreation/Assets
          - export LD_LIBRARY_PATH=/app/lib/pacman-recreation:$LD_LIBRARY_PATH
          - exec /app/lib/pacman-recreation/PacmanGame
