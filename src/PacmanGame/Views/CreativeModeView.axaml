<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:conv="using:PacmanGame.Converters"
             xmlns:vm="using:PacmanGame.ViewModels.Creative"
             mc:Ignorable="d"
             x:Class="PacmanGame.Views.CreativeModeView"
             x:DataType="vm:CreativeModeViewModel"
             x:Name="CreativeRoot"
             KeyDown="OnKeyDown"
             Focusable="True">

  <UserControl.Resources>
    <ResourceDictionary>
      <conv:CreativeCellBrushConverter x:Key="CellBrush" />
      <conv:CreativeCursorBrushConverter x:Key="CursorBrush" />
      <conv:ToolIconGeometryConverter x:Key="ToolIcon" />
      <conv:InverseBooleanConverter x:Key="InverseBool" />
    </ResourceDictionary>
  </UserControl.Resources>
  <Grid ColumnDefinitions="220,*,340" Background="{DynamicResource AppBackgroundBrush}">
    <Border Grid.Column="0" Margin="12" CornerRadius="8" BorderThickness="2" BorderBrush="{DynamicResource AppAccentBrush}" Background="{DynamicResource AppSurfaceBrush}">
      <StackPanel Margin="12" Spacing="8">
        <TextBlock Text="Keyboard" FontSize="16" FontWeight="Bold" Foreground="{DynamicResource AppAccentBrush}"/>
        <TextBlock Text="{Binding MoveCursorKeyText}" />
        <TextBlock Text="{Binding PlaceTileKeyText}" />
        <TextBlock Text="{Binding DeleteTileKeyText}" />
        <TextBlock Text="{Binding CycleToolsKeyText}" />
        <TextBlock Text="{Binding RotateTileKeyText}" />
        <TextBlock Text="{Binding PlayTestKeyText}" />
        <TextBlock Text="{Binding ExportKeyText}" />
        <TextBlock Text="{Binding ImportKeyText}" />
      </StackPanel>
    </Border>

    <Border Grid.Column="1" Margin="12" CornerRadius="8" BorderBrush="{DynamicResource AppBorderStrongBrush}" BorderThickness="2" Background="{DynamicResource AppSurface2Brush}">
        <StackPanel Spacing="6" Margin="12">
          <StackPanel Orientation="Horizontal" VerticalAlignment="Center" Spacing="8">
            <Button Content="-" Command="{Binding ZoomOutCommand}" Width="32" Height="32"/>
            <Slider Width="200"
                    Minimum="0.5"
                    Maximum="2"
                    SmallChange="0.1"
                    LargeChange="0.2"
                    Value="{Binding ZoomLevel}"/>
            <Button Content="+" Command="{Binding ZoomInCommand}" Width="32" Height="32"/>
            <TextBlock Text="{Binding ZoomLabel}" VerticalAlignment="Center" Margin="8,0,0,0"/>
          </StackPanel>
          <StackPanel Orientation="Horizontal" VerticalAlignment="Center" Spacing="10">
            <Button Content="◄ Prev Level"
                    Command="{Binding PreviousLevelCommand}"
                    IsEnabled="{Binding CanGoPreviousLevel}"
                    MinWidth="120"/>
            <TextBlock Text="{Binding CurrentLevelInfo}"
                       Foreground="{DynamicResource AppTextMutedBrush}"
                       VerticalAlignment="Center"
                       HorizontalAlignment="Center"/>
            <Button Content="Next Level ►"
                    Command="{Binding NextLevelCommand}"
                    IsEnabled="{Binding CanGoNextLevel}"
                    MinWidth="120"/>
          </StackPanel>
          <TextBlock Text="{Binding CanvasViewModel.StatusMessage}"
                     Foreground="{DynamicResource AppTextMutedBrush}"
                     FontSize="12"
                     TextWrapping="Wrap"/>

        <ScrollViewer HorizontalScrollBarVisibility="Auto"
                      VerticalScrollBarVisibility="Auto"
                      PointerWheelChanged="OnPointerWheelChanged">
          <Grid x:Name="CanvasLayer"
                Width="{Binding GridPixelWidth}"
                Height="{Binding GridPixelHeight}"
                RenderTransformOrigin="0,0"
                PointerPressed="OnCanvasPointerPressed">
            <Grid.RenderTransform>
              <ScaleTransform ScaleX="{Binding ZoomLevel}" ScaleY="{Binding ZoomLevel}" />
            </Grid.RenderTransform>

            <ItemsControl ItemsSource="{Binding CanvasViewModel.Cells}"
                          Width="{Binding GridPixelWidth}"
                          Height="{Binding GridPixelHeight}">
              <ItemsControl.ItemsPanel>
                <ItemsPanelTemplate>
                  <UniformGrid Columns="28" />
                </ItemsPanelTemplate>
              </ItemsControl.ItemsPanel>
              <ItemsControl.ItemTemplate>
                <DataTemplate>
                  <Grid Width="22" Height="22" Margin="1">
                    <Image Source="{Binding Sprite}"
                           Width="20"
                           Height="20"
                           Stretch="Fill"
                           HorizontalAlignment="Center"
                           VerticalAlignment="Center" />
                    <Border BorderThickness="2"
                            BorderBrush="{DynamicResource AppAccentBrush}"
                            IsVisible="{Binding IsSelected}" />
                    <Border BorderThickness="1"
                            BorderBrush="{Binding IsCursor, Converter={StaticResource CursorBrush}}"
                            IsVisible="{Binding IsCursor}" />
                  </Grid>
                </DataTemplate>
              </ItemsControl.ItemTemplate>
            </ItemsControl>

            <Canvas x:Name="GridLinesLayer"
                    Width="{Binding GridPixelWidth}"
                    Height="{Binding GridPixelHeight}"
                    IsHitTestVisible="False">
              <ItemsControl ItemsSource="{Binding VerticalGridLines}">
                <ItemsControl.ItemTemplate>
                  <DataTemplate>
                    <Rectangle Width="1"
                               Height="{Binding ElementName=GridLinesLayer, Path=Height}"
                               Fill="{DynamicResource AppGridLineBrush}"
                               Canvas.Left="{Binding}" />
                  </DataTemplate>
                </ItemsControl.ItemTemplate>
              </ItemsControl>
              <ItemsControl ItemsSource="{Binding HorizontalGridLines}">
                <ItemsControl.ItemTemplate>
                  <DataTemplate>
                    <Rectangle Height="1"
                               Width="{Binding ElementName=GridLinesLayer, Path=Width}"
                               Fill="{DynamicResource AppGridLineBrush}"
                               Canvas.Top="{Binding}" />
                  </DataTemplate>
                </ItemsControl.ItemTemplate>
              </ItemsControl>
              <ItemsControl ItemsSource="{Binding MajorVerticalLines}">
                <ItemsControl.ItemTemplate>
                  <DataTemplate>
                    <Rectangle Width="1"
                               Height="{Binding ElementName=GridLinesLayer, Path=Height}"
                               Fill="{DynamicResource AppGridLineMajorBrush}"
                               Opacity="0.7"
                               Canvas.Left="{Binding}" />
                  </DataTemplate>
                </ItemsControl.ItemTemplate>
              </ItemsControl>
              <ItemsControl ItemsSource="{Binding MajorHorizontalLines}">
                <ItemsControl.ItemTemplate>
                  <DataTemplate>
                    <Rectangle Height="1"
                               Width="{Binding ElementName=GridLinesLayer, Path=Width}"
                               Fill="{DynamicResource AppGridLineMajorBrush}"
                               Opacity="0.7"
                               Canvas.Top="{Binding}" />
                  </DataTemplate>
                </ItemsControl.ItemTemplate>
              </ItemsControl>
            </Canvas>

            <Canvas Width="{Binding GridPixelWidth}"
                    Height="{Binding GridPixelHeight}"
                    IsHitTestVisible="False">
              <Rectangle Width="{Binding CellDisplaySize}"
                         Height="{Binding CellDisplaySize}"
                         Stroke="{DynamicResource AppAccentBrush}"
                         StrokeThickness="2"
                         Fill="Transparent"
                         Canvas.Left="{Binding CursorLeft}"
                         Canvas.Top="{Binding CursorTop}"
                         IsVisible="{Binding HasSelectedTool}" />

              <Image Source="{Binding ToolboxViewModel.SelectedToolEntry.Icon}"
                     Width="18"
                     Height="18"
                     Opacity="0.65"
                     Canvas.Left="{Binding CursorLeft}"
                     Canvas.Top="{Binding CursorTop}"
                     IsVisible="{Binding HasSelectedTool}"
                     RenderTransformOrigin="0.5,0.5">
                <Image.RenderTransform>
                  <RotateTransform Angle="{Binding CursorRotation}" />
                </Image.RenderTransform>
              </Image>

              <TextBlock Text="{Binding CursorRotation, StringFormat='{}{0}°'}"
                         FontSize="10"
                         Foreground="{DynamicResource AppAccentBrush}"
                         Canvas.Left="{Binding CursorRotationLabelLeft}"
                         Canvas.Top="{Binding CursorRotationLabelTop}"
                         IsVisible="{Binding SelectedToolRotatable}" />
            </Canvas>
          </Grid>
        </ScrollViewer>
      </StackPanel>
    </Border>

    <Border Grid.Column="2" Margin="12" CornerRadius="8" BorderBrush="{DynamicResource AppAccentBrush}" BorderThickness="2" Background="{DynamicResource AppSurfaceBrush}">
      <StackPanel Margin="12" Spacing="12">
        <TextBlock Text="Toolbox" FontSize="16" FontWeight="Bold" Foreground="{DynamicResource AppAccentBrush}"/>

        <StackPanel Orientation="Horizontal" Spacing="8" VerticalAlignment="Center">
          <Button Content="◄" Command="{Binding PreviousLevelCommand}" IsEnabled="{Binding CanGoPreviousLevel}" Width="36" Height="32"/>
          <TextBlock Text="Level" VerticalAlignment="Center" Foreground="{DynamicResource AppTextMutedBrush}"/>
          <NumericUpDown Value="{Binding SelectedLevelNumber}"
                         Minimum="1"
                         Maximum="{Binding LevelCount}"
                         Width="80" />
          <TextBlock Text="{Binding LevelCount, StringFormat='/ {0}'}" VerticalAlignment="Center" Foreground="{DynamicResource AppTextMutedBrush}"/>
          <Button Content="►" Command="{Binding NextLevelCommand}" IsEnabled="{Binding CanGoNextLevel}" Width="36" Height="32"/>
        </StackPanel>

        <TabControl>
          <TabItem Header="Tools">
            <ScrollViewer VerticalScrollBarVisibility="Auto" HorizontalScrollBarVisibility="Disabled">
              <ListBox x:Name="ToolList"
                       Classes="tool-list"
                       ItemsSource="{Binding ToolboxViewModel.Tools}"
                       SelectedItem="{Binding ToolboxViewModel.SelectedToolEntry, Mode=TwoWay}"
                       BorderBrush="Transparent">
              <ListBox.Styles>
                <Style Selector="ListBoxItem">
                  <Setter Property="Background" Value="Transparent"/>
                  <Setter Property="Padding" Value="6"/>
                  <Setter Property="Margin" Value="2"/>
                </Style>
                <Style Selector="ListBoxItem TextBlock">
                  <Setter Property="Foreground" Value="{DynamicResource AppTextPrimaryBrush}"/>
                </Style>
                <Style Selector="ListBoxItem TextBlock.tool-desc">
                  <Setter Property="Foreground" Value="{DynamicResource AppTextMutedBrush}"/>
                </Style>
                <Style Selector="ListBoxItem:pointerover">
                  <Setter Property="Background" Value="{DynamicResource AppSurface2Brush}"/>
                </Style>
                <Style Selector="ListBoxItem:selected">
                  <Setter Property="Background" Value="{DynamicResource AppAccentBrush}"/>
                  <Setter Property="BorderBrush" Value="{DynamicResource AppBorderStrongBrush}"/>
                  <Setter Property="BorderThickness" Value="2"/>
                </Style>
                <Style Selector="ListBoxItem:selected TextBlock">
                  <Setter Property="Foreground" Value="{DynamicResource AppBackgroundBrush}"/>
                </Style>
                <Style Selector="ListBoxItem:selected Border.tool-icon-bg">
                  <Setter Property="Background" Value="{DynamicResource AppBackgroundBrush}"/>
                </Style>
                <Style Selector="ListBoxItem:selected Border.shortcut-badge">
                  <Setter Property="Background" Value="{DynamicResource AppBackgroundBrush}"/>
                </Style>
                <Style Selector="ListBoxItem:selected Border.shortcut-badge TextBlock">
                  <Setter Property="Foreground" Value="{DynamicResource AppTextPrimaryBrush}"/>
                </Style>
              </ListBox.Styles>
              <ListBox.ItemTemplate>
                <DataTemplate>
                  <Grid ColumnDefinitions="42,*,50" VerticalAlignment="Center">
                    <ToolTip.Tip>
                      <ToolTip>
                        <StackPanel>
                          <TextBlock Text="{Binding Label}" FontWeight="Bold" />
                          <TextBlock Text="{Binding Description}" Foreground="{DynamicResource AppTextMutedBrush}" FontSize="12" TextWrapping="Wrap" MaxWidth="220" Margin="0,4,0,0"/>
                          <TextBlock Text="{Binding Shortcut, StringFormat='Shortcut: {0}'}" Foreground="{DynamicResource AppTextMutedBrush}" FontSize="10" Margin="0,6,0,0"/>
                        </StackPanel>
                      </ToolTip>
                    </ToolTip.Tip>
                    <Border Width="36" Height="36" CornerRadius="6" Background="{DynamicResource AppSurface2Brush}" HorizontalAlignment="Center" VerticalAlignment="Center" Classes="tool-icon-bg">
                      <Image Source="{Binding Icon}"
                             Width="28"
                             Height="28"
                             HorizontalAlignment="Center"
                             VerticalAlignment="Center"
                             Stretch="Uniform" />
                    </Border>
                    <StackPanel Grid.Column="1" Spacing="2">
                      <TextBlock Text="{Binding Label}"
                                 FontSize="16"
                                 FontFamily="{StaticResource ArcadeFont}" />
                      <TextBlock Text="{Binding Description}"
                                 Classes="tool-desc"
                                 TextWrapping="Wrap"
                                 FontSize="12"
                                 />
                    </StackPanel>
                    <Border Grid.Column="2"
                            Background="{DynamicResource AppBorderBrush}"
                            CornerRadius="4"
                            Padding="4"
                            HorizontalAlignment="Right"
                            VerticalAlignment="Center"
                            Classes="shortcut-badge">
                      <TextBlock Text="{Binding Shortcut}"
                                 FontSize="10"
                                 FontFamily="{StaticResource ArcadeFont}" />
                    </Border>
                  </Grid>
                </DataTemplate>
              </ListBox.ItemTemplate>
              </ListBox>
            </ScrollViewer>
          </TabItem>
          <TabItem Header="Config">
            <ScrollViewer>
              <StackPanel Spacing="10" Margin="6">
                <TextBlock Text="Lives" />
                <NumericUpDown Value="{Binding Lives}" Minimum="1" Maximum="5" />

                <TextBlock Text="Number of Levels" Margin="0,10,0,0"/>
                <NumericUpDown Value="{Binding LevelCount}" Minimum="1" Maximum="10" />

                <TextBlock Text="Win Score" Margin="0,10,0,0"/>
                <NumericUpDown Value="{Binding WinScore}"
                               Minimum="{Binding WinScoreMin}"
                               Maximum="{Binding WinScoreMax}" />
                <TextBlock Text="{Binding WinScoreRange}" Foreground="{DynamicResource AppTextMutedBrush}" FontSize="10"/>

                <TextBlock Text="Level Settings" Margin="0,10,0,0" FontWeight="Bold"/>
                <Expander Header="Per Level" IsExpanded="True">
                  <StackPanel Spacing="6"
                              Margin="0,10"
                              DataContext="{Binding SelectedLevelConfig}">
                    <TextBlock Text="{Binding LevelNumber, StringFormat='Level {0}'}"
                               Foreground="{DynamicResource AppAccentBrush}"
                               FontWeight="Bold" />

                    <TextBlock Text="Pac-Man Speed" Foreground="{DynamicResource AppTextPrimaryBrush}"/>
                    <Slider Value="{Binding PacmanSpeedMultiplier}"
                            Minimum="{Binding MinAllowedSpeedMultiplier}"
                            Maximum="{Binding MaxAllowedSpeedMultiplier}"
                            TickFrequency="0.1" />
                    <TextBlock Text="{Binding PacmanSpeedMultiplier, StringFormat='×{0:F1}'}"
                               Foreground="{DynamicResource AppTextMutedBrush}" />

                    <TextBlock Text="Ghost Speed" Foreground="{DynamicResource AppTextPrimaryBrush}"/>
                    <Slider Value="{Binding GhostSpeedMultiplier}"
                            Minimum="{Binding MinAllowedSpeedMultiplier}"
                            Maximum="{Binding MaxAllowedSpeedMultiplier}"
                            TickFrequency="0.1" />
                    <TextBlock Text="{Binding GhostSpeedMultiplier, StringFormat='×{0:F1}'}"
                               Foreground="{DynamicResource AppTextMutedBrush}" />

                    <TextBlock Text="Frightened Duration (s)" Foreground="{DynamicResource AppTextPrimaryBrush}"/>
                    <NumericUpDown Value="{Binding FrightenedDuration}"
                                   Minimum="1"
                                   Maximum="{Binding MaxFrightenedDuration}" />
                    <TextBlock Text="{Binding MaxFrightenedDuration, StringFormat='Max: {0}s'}"
                               Foreground="{DynamicResource AppTextMutedBrush}"
                               FontSize="10"/>

                    <TextBlock Text="Fruit Points" Foreground="{DynamicResource AppTextPrimaryBrush}"/>
                    <NumericUpDown Value="{Binding FruitPoints}"
                                   Minimum="1"
                                   Maximum="{Binding MaxFruitPoints}" />
                    <TextBlock Text="{Binding MaxFruitPoints, StringFormat='Max: {0}'}"
                               Foreground="{DynamicResource AppTextMutedBrush}"
                               FontSize="10"/>

                    <TextBlock Text="Ghost Eat Points" Foreground="{DynamicResource AppTextPrimaryBrush}"/>
                    <NumericUpDown Value="{Binding GhostEatPoints}"
                                   Minimum="10"
                                   Maximum="{Binding MaxGhostEatPoints}" />
                    <TextBlock Text="{Binding MaxGhostEatPoints, StringFormat='Max: {0}'}"
                               Foreground="{DynamicResource AppTextMutedBrush}"
                               FontSize="10"/>
                  </StackPanel>
                </Expander>
              </StackPanel>
            </ScrollViewer>
          </TabItem>
        </TabControl>

        <TextBlock Text="{Binding CursorShortcut, StringFormat='Shortcut: {0}'}"
                   Foreground="{DynamicResource AppTextMutedBrush}"
                   FontSize="12"
                   Margin="0,4,0,0" />
        <StackPanel Spacing="6">
          <Button Content="Play Test" Command="{Binding PlayTestCommand}" Classes="arcade"/>
          <Button Content="Export" Command="{Binding ExportCommand}" Classes="arcade"/>
          <Button Content="Import" Command="{Binding ImportCommand}" Classes="arcade"/>
          <Button Content="Close Editor" Command="{Binding CloseCommand}" Classes="arcade"/>
        </StackPanel>
      </StackPanel>
    </Border>

    <!-- Export options modal -->
    <Border Grid.ColumnSpan="3"
            Background="{DynamicResource AppOverlayBrush}"
            IsVisible="{Binding IsExportOptionsOpen}">
      <Border Width="420"
              CornerRadius="10"
              BorderBrush="{DynamicResource AppAccentBrush}"
              BorderThickness="2"
              Background="{DynamicResource AppSurfaceBrush}"
              Padding="16"
              HorizontalAlignment="Center"
              VerticalAlignment="Center">
        <StackPanel Spacing="12">
          <TextBlock Text="Export Pac-Man Project"
                     FontSize="18"
                     FontWeight="Bold"
                     Foreground="{DynamicResource AppAccentBrush}"/>

          <StackPanel Spacing="6">
            <TextBlock Text="Project Name" />
            <TextBox Text="{Binding ExportProjectName}" />
          </StackPanel>

          <StackPanel Spacing="6">
            <TextBlock Text="Export Mode" />
            <RadioButton Content="Allow editing after import"
                         IsChecked="{Binding ExportIsEditable}" />
            <RadioButton Content="Play-only (locked for editing)"
                         IsChecked="{Binding ExportIsEditable, Converter={StaticResource InverseBool}}" />
          </StackPanel>

          <StackPanel Orientation="Horizontal" HorizontalAlignment="Right" Spacing="10">
            <Button Content="Cancel" Command="{Binding CancelExportCommand}" />
            <Button Content="Export" Command="{Binding ConfirmExportCommand}" />
          </StackPanel>
        </StackPanel>
      </Border>
    </Border>

    <!-- Import preview modal -->
    <Border Grid.ColumnSpan="3"
            Background="{DynamicResource AppOverlayBrush}"
            IsVisible="{Binding IsImportPreviewOpen}">
      <Border Width="520"
              CornerRadius="10"
              BorderBrush="{DynamicResource AppAccentBrush}"
              BorderThickness="2"
              Background="{DynamicResource AppSurfaceBrush}"
              Padding="16"
              HorizontalAlignment="Center"
              VerticalAlignment="Center">
        <StackPanel Spacing="12">
          <TextBlock Text="Import Pac-Man Project"
                     FontSize="18"
                     FontWeight="Bold"
                     Foreground="{DynamicResource AppAccentBrush}"/>

          <Grid ColumnDefinitions="120,*" RowDefinitions="Auto,Auto,Auto,Auto" Margin="0,4,0,0">
            <TextBlock Text="Name:" />
            <TextBlock Grid.Column="1" Text="{Binding ImportSummary.ProjectName}" Foreground="{DynamicResource AppTextMutedBrush}" />

            <TextBlock Grid.Row="1" Text="Author:" />
            <TextBlock Grid.Row="1" Grid.Column="1" Text="{Binding ImportSummary.Author}" Foreground="{DynamicResource AppTextMutedBrush}" />

            <TextBlock Grid.Row="2" Text="Levels:" />
            <TextBlock Grid.Row="2" Grid.Column="1" Text="{Binding ImportSummary.LevelCount}" Foreground="{DynamicResource AppTextMutedBrush}" />

            <TextBlock Grid.Row="3" Text="Editable:" />
            <TextBlock Grid.Row="3" Grid.Column="1" Text="{Binding ImportSummary.IsEditable}" Foreground="{DynamicResource AppTextMutedBrush}" />
          </Grid>

          <StackPanel Orientation="Horizontal" HorizontalAlignment="Center" Spacing="12">
            <Button Content="Cancel" Command="{Binding CancelImportPreviewCommand}" Width="110" />
            <Button Content="Play" Command="{Binding ImportPlayCommand}" Width="110" />
            <Button Content="Edit" Command="{Binding ImportEditCommand}" Width="110" IsEnabled="{Binding ImportCanEdit}" />
          </StackPanel>

          <TextBlock Text="This project is locked and cannot be edited."
                     Foreground="{DynamicResource AppDangerBrush}"
                     IsVisible="{Binding ImportCanEdit, Converter={StaticResource InverseBool}}"
                     HorizontalAlignment="Center"/>
        </StackPanel>
      </Border>
    </Border>
  </Grid>
</UserControl>
